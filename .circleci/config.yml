version: 2

workflows:
  version: 2
  test:
    jobs:
      - run_tests
  deploy:
    jobs:
      - run_tests:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
      - run_deploy:
          requires:
            - run_tests
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
jobs:
  run_tests:
    machine: true

    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "d6:31:51:4e:99:10:73:5c:97:51:06:8c:fb:30:a5:83"
      - run:
          name: Set up a local Solr with build's solr config.
          command: bash .circleci/setup_solr.sh
      - run:
          name: Test that we can get to the solr collection successfully.
          command: bash .circleci/test.sh

  run_deploy:
    docker:
      - image: circleci/python:3.6.6
        environment:
          PIPENV_VENV_IN_PROJECT: true
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "d6:31:51:4e:99:10:73:5c:97:51:06:8c:fb:30:a5:83"
      - run:
          name: Build configuration asset
          command: bash .circleci/build.sh
      - run:
          name: Deploy configuration asset to SolrCloud
          command: bash .circleci/deploy.sh
